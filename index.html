<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T.C. Arkeolojik Miras Denetim PortalÄ±</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        :root {
            --gov-blue: #0b1a30;
            --gov-accent: #1a3a5f;
            --gold: #c5a059;
            --light-bg: #f4f7f9;
            --white: #ffffff;
            --danger: #d90429;
            --success: #2b9348;
        }
        
        body { margin: 0; font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--light-bg); color: var(--gov-blue); }
        
        header { 
            background: var(--gov-blue); 
            color: white; 
            padding: 40px 20px; 
            text-align: center; 
            border-bottom: 4px solid var(--gold);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .container { max-width: 900px; margin: -30px auto 50px; padding: 0 15px; }

        .card { 
            background: var(--white); 
            border-radius: 12px; 
            padding: 35px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.08); 
            border-top: 5px solid var(--gov-accent);
        }

        .official-badge {
            display: inline-block;
            background: var(--light-bg);
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--gov-accent);
        }

        h2 { border-bottom: 2px solid var(--light-bg); padding-bottom: 10px; margin-top: 0; font-size: 22px; }

        .stat-card { 
            background: var(--gov-blue); 
            color: var(--gold); 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
            font-size: 18px; 
            font-weight: bold; 
            margin-bottom: 25px; 
        }

        #map { height: 380px; border-radius: 10px; border: 1px solid #ccd; margin: 10px 0; z-index: 1; }
        
        .form-group { margin-bottom: 20px; }
        label { font-weight: 600; font-size: 14px; margin-bottom: 8px; display: block; color: var(--gov-accent); }
        
        input, textarea, select { 
            width: 100%; padding: 14px; border-radius: 8px; border: 1px solid #ced4da; 
            box-sizing: border-box; font-size: 15px; transition: 0.2s;
        }
        input:focus, textarea:focus { border-color: var(--gold); outline: none; box-shadow: 0 0 0 3px rgba(197, 160, 89, 0.2); }

        /* Upload Area TasarÄ±mÄ± */
        .upload-area { 
            border: 2px dashed #b1bdce; border-radius: 10px; padding: 30px; 
            text-align: center; background: #f8f9fa; cursor: pointer; transition: 0.3s;
        }
        .upload-area:hover { background: #edf2f7; border-color: var(--gov-accent); }
        
        .preview-container { display: flex; gap: 15px; margin-top: 20px; justify-content: center; }
        .preview-item { 
            position: relative; width: 100px; height: 100px; 
            border-radius: 8px; border: 2px solid var(--gold); overflow: hidden; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-img { 
            position: absolute; top: 0; right: 0; background: var(--danger); 
            color: white; border: none; width: 22px; height: 22px; cursor: pointer; font-size: 14px;
        }

        .btn-main { 
            background: var(--gov-blue); color: var(--gold); border: 1px solid var(--gold);
            padding: 18px; border-radius: 8px; width: 100%; font-size: 16px; 
            font-weight: bold; cursor: pointer; transition: 0.3s; letter-spacing: 1px;
        }
        .btn-main:hover { background: var(--gov-accent); transform: translateY(-2px); }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 2% auto; padding: 40px; border-radius: 12px; width: 90%; max-width: 800px; position: relative; }
        .close-modal { position: absolute; right: 25px; top: 20px; font-size: 30px; cursor: pointer; }

        #adminMap { height: 250px; border-radius: 10px; margin: 15px 0; border: 1px solid #ddd; }
        .zoom-btn { background: var(--gov-blue); color: var(--gold); border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; vertical-align: middle; }

        @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr !important; } }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>

<header>
    <div style="font-size: 40px; margin-bottom: 10px;">âš–ï¸</div>
    <h1 style="margin:0; letter-spacing: 1px;">T.C. ARKEOLOJÄ°K MÄ°RAS DENETÄ°M PORTALI</h1>
    <p style="opacity: 0.8; font-weight: 300;">VatandaÅŸ Bildirim ve KanÄ±t Takip Sistemi</p>
</header>

<div class="container">
    <div class="card">
        <div class="official-badge"><i class="fas fa-shield-alt"></i> RESMÄ° BÄ°LDÄ°RÄ°M FORMU</div>
        <div class="stat-card">SÄ°STEMDEKÄ° TOPLAM KAYIT: <span id="countVal">0</span></div>

        <div class="form-group">
            <label>Bildirim Sahibi Bilgileri</label>
            <input type="text" id="rName" placeholder="Ad Soyad (Gizli kalmak iÃ§in boÅŸ bÄ±rakÄ±nÄ±z)">
        </div>
        
        <div class="grid-2">
            <div class="form-group"><label>Olay Tarihi</label><input type="date" id="eventDate"></div>
            <div class="form-group"><label>Tespit Saati</label><input type="time" id="eventTime"></div>
        </div>

        <div class="form-group">
            <label>OlayÄ±n DetaylÄ± AÃ§Ä±klamasÄ±</label>
            <textarea id="rDesc" rows="4" placeholder="ÅÃ¼pheli faaliyetin detaylarÄ±nÄ±, araÃ§ plakalarÄ±nÄ± veya kiÅŸi tanÄ±mlarÄ±nÄ± yazÄ±nÄ±z..."></textarea>
        </div>

        <div class="form-group">
            <label>GÃ¶rsel KanÄ±t DosyalarÄ± (Maksimum 3 Adet)</label>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept="image/*" multiple style="display:none" onchange="handleMultipleFiles(this)">
                <i class="fas fa-file-upload" style="font-size: 35px; color: var(--gov-accent); margin-bottom: 10px;"></i>
                <p id="upload-status-text" style="font-weight: 600; margin: 5px 0;">DosyalarÄ± SeÃ§mek Ä°Ã§in Buraya TÄ±klayÄ±n</p>
                <div class="preview-container" id="previewContainer"></div>
            </div>
        </div>

        <div class="form-group">
            <label>Konum Tespiti (Harita Ãœzerinden Ä°ÅŸaretleyiniz)</label>
            <div id="map"></div>
        </div>
        
        <button class="btn-main" onclick="submitReport()">BÄ°LDÄ°RÄ°MÄ° RESMÄ° MAKAMLARA Ä°LET</button>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeDetail()">&times;</span>
        <h2 style="color: var(--gov-blue);"><i class="fas fa-folder-open"></i> VAKA Ä°NCELEME DOSYASI</h2>
        <div id="mBody" style="background: #fdfdfd; padding: 20px; border: 1px solid #eee; border-radius: 8px;"></div>
        <div id="adminMap"></div>
        <div id="mImages" style="display: grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-top: 20px;"></div>
        <div id="modalFooter" style="margin-top: 25px;"></div>
    </div>
</div>

<script>
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbyFcIai4hAuiVG_M3q_vYnEQS5R1LFq14izib1MqoO2vXOe4Zi2IHR5mYuSOlPYEpye/exec";
    const DEPO_URL = "https://script.google.com/macros/s/AKfycbz6yl6eh7_E5nc00tTWTJdE9M2sOr-781p7tXqXvCZ9J7TVcYUVADok-HMRo_azlY8xmg/exec"; 
    const GIZLI_ANAHTAR = "LegologlarFLL2024";

    let photoArray = [];
    let cachedReports = {}; 
    let adminMap = null, adminMarker = null;
    
    var map = L.map('map').setView([39.0, 35.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var marker = null, selectedLoc = null;

    map.on('click', function(e) {
        selectedLoc = e.latlng;
        if(marker) map.removeLayer(marker);
        marker = L.marker(selectedLoc).addTo(map);
    });

    function handleMultipleFiles(input) {
        const files = Array.from(input.files);
        if (photoArray.length + files.length > 3) { alert("Sistem en fazla 3 kanÄ±t fotoÄŸrafÄ±na izin vermektedir."); return; }
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    const maxWidth = 1000;
                    let width = img.width, height = img.height;
                    if (width > maxWidth) { height = (maxWidth / width) * height; width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    photoArray.push(canvas.toDataURL('image/jpeg', 0.8));
                    renderPreviews();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    function renderPreviews() {
        const container = document.getElementById('previewContainer');
        container.innerHTML = "";
        photoArray.forEach((src, index) => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `<img src="${src}"><button class="remove-img" onclick="event.stopPropagation(); removePhoto(${index})">&times;</button>`;
            container.appendChild(div);
        });
        document.getElementById('upload-status-text').innerText = photoArray.length > 0 ? `${photoArray.length} Dosya Eklendi` : "DosyalarÄ± SeÃ§mek Ä°Ã§in Buraya TÄ±klayÄ±n";
    }

    function removePhoto(index) { photoArray.splice(index, 1); renderPreviews(); }

    async function getAddress(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const data = await response.json();
            return data.display_name || "Konum bilgisi alÄ±namadÄ±.";
        } catch (e) { return "Adres servisi kullanÄ±lamÄ±yor."; }
    }

    async function submitReport() {
        const desc = document.getElementById('rDesc').value;
        if(!selectedLoc || desc.length < 10) { alert("LÃ¼tfen haritadan konum iÅŸaretleyiniz ve geÃ§erli bir aÃ§Ä±klama giriniz."); return; }
        const rawData = { ad: document.getElementById('rName').value || "Anonim Bildirim", detay: desc, koordinat: selectedLoc, tarih: new Date().toLocaleString(), olayZamani: `${document.getElementById('eventDate').value} ${document.getElementById('eventTime').value}`, fotolar: photoArray, guven: Math.min(40 + (photoArray.length * 20), 100) };
        const securePackage = CryptoJS.AES.encrypt(JSON.stringify(rawData), GIZLI_ANAHTAR).toString();
        try {
            fetch(DEPO_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ secureData: securePackage }) });
            fetch(BACKEND_URL, { method: 'POST', mode: 'no-cors' });
            alert("Bildiriminiz resmi kayÄ±tlarÄ±mÄ±za alÄ±nmÄ±ÅŸtÄ±r. TeÅŸekkÃ¼r ederiz."); location.reload();
        } catch (e) { alert("Sistem hatasÄ±!"); }
    }

    async function renderAdminView() {
        document.getElementById('main-content').innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom: 2px solid var(--gov-blue); padding-bottom:15px;">
                <h2 style="margin:0;"><i class="fas fa-lock"></i> YÃ–NETÄ°CÄ° DENETÄ°M PANELÄ°</h2>
                <button onclick="location.reload()" style="padding:10px 20px; border-radius:5px; background:var(--danger); color:white; border:none; cursor:pointer;">PANELÄ° KAPAT</button>
            </div>
            <div id="admin-list">VeritabanÄ± sorgulanÄ±yor...</div>`;
        try {
            const res = await fetch(DEPO_URL);
            const data = await res.json();
            let html = "<table style='width:100%; border-collapse:collapse;'>";
            html += "<tr style='background:var(--gov-accent); color:var(--gold);'><th style='padding:15px;'>GÃœVEN</th><th>Ä°HBARCI</th><th>TARÄ°H</th><th>EYLEM</th></tr>";
            data.forEach((row, index) => {
                let enc = ""; for(let i = 1; i < row.length; i++) { if (row[i]) enc += String(row[i]).replace(/^'/, ''); }
                try {
                    const dec = JSON.parse(CryptoJS.AES.decrypt(enc, GIZLI_ANAHTAR).toString(CryptoJS.enc.Utf8));
                    cachedReports[index] = dec;
                    html += `<tr style='border-bottom:1px solid #eee;'><td style='padding:15px; font-weight:bold; color:var(--success)'>%${dec.guven}</td><td>${dec.ad}</td><td>${dec.olayZamani}</td><td><button class="zoom-btn" onclick="openDetail(${index})">DOSYAYI AÃ‡</button></td></tr>`;
                } catch(e){}
            });
            document.getElementById('admin-list').innerHTML = html + "</table>";
        } catch (e) { }
    }

    async function openDetail(index) {
        const item = cachedReports[index];
        const addr = await getAddress(item.koordinat.lat, item.koordinat.lng);
        document.getElementById('mBody').innerHTML = `
            <p><strong>ğŸ“ Koordinatlar:</strong> ${item.koordinat.lat.toFixed(6)}, ${item.koordinat.lng.toFixed(6)} <button class="zoom-btn" onclick="zoomIn()"><i class="fas fa-search-plus"></i></button></p>
            <p><strong>ğŸ  Adres Tespiti:</strong> ${addr}</p>
            <p><strong>ğŸ‘¤ Bildiren:</strong> ${item.ad}</p>
            <p><strong>ğŸ“ Vaka DetayÄ±:</strong> ${item.detay}</p>
        `;
        let imgs = ""; (item.fotolar || []).forEach(s => imgs += `<img src="${s}" style="width:100%; border:1px solid #ddd; border-radius:5px;">`);
        document.getElementById('mImages').innerHTML = imgs;
        document.getElementById('modalFooter').innerHTML = `<button onclick="downloadJSON(${index})" style="padding:15px; width:100%; background:var(--gov-blue); color:var(--gold); border:none; border-radius:8px; cursor:pointer; font-weight:bold;">DOSYAYI JSON OLARAK ARÅÄ°VLE</button>`;
        document.getElementById('detailModal').style.display = "block";
        setTimeout(() => {
            if(!adminMap) {
                adminMap = L.map('adminMap').setView([item.koordinat.lat, item.koordinat.lng], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(adminMap);
            } else { adminMap.setView([item.koordinat.lat, item.koordinat.lng], 14); adminMap.invalidateSize(); }
            if(adminMarker) adminMap.removeLayer(adminMarker);
            adminMarker = L.marker([item.koordinat.lat, item.koordinat.lng]).addTo(adminMap);
        }, 300);
    }

    function zoomIn() { if(adminMap) adminMap.setZoom(18); }
    function closeDetail() { document.getElementById('detailModal').style.display = "none"; }
    
    window.onload = () => {
        const p = new URLSearchParams(window.location.search);
        if (p.get('admin') === 'true' && prompt("EriÅŸim Kodu:") === "1234") renderAdminView();
        fetch(BACKEND_URL).then(r=>r.json()).then(d=>document.getElementById('countVal').innerText = d.total);
    };
</script>
</body>
</html>
