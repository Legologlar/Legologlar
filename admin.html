<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Y√∂netici Paneli | LEGOLOGLAR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --primary: #00b4d8; --secondary: #03045e; --accent: #0096c7; --bg: #f1f3f8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .admin-card { background: white; border-radius: 15px; padding: 25px; max-width: 900px; margin: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        .guven-tag { padding: 4px 8px; border-radius: 5px; color: white; font-weight: bold; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); overflow-y: auto; }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 80%; border-radius: 10px; }
        .btn-view { background: var(--accent); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .btn-del { background: #e63946; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

<div class="admin-card" id="admin-area">
    <h2>üïµÔ∏è Y√∂netici Kontrol Paneli</h2>
    <div id="status">Eri≈üim kontrol ediliyor...</div>
    <div id="list-container"></div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span style="float:right; cursor:pointer; font-size:24px;" onclick="closeDetail()">&times;</span>
        <h3>ƒ∞hbar Detayƒ±</h3>
        <div id="mBody"></div>
        <div id="mImages" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:15px;"></div>
        <button id="delBtn" class="btn-del">ƒ∞HBARI KALICI OLARAK Sƒ∞L</button>
    </div>
</div>

<script>
    const DEPO_URL = "https://script.google.com/macros/s/AKfycbz6yl6eh7_E5nc00tTWTJdE9M2sOr-781p7tXqXvCZ9J7TVcYUVADok-HMRo_azlY8xmg/exec"; 
    const GIZLI_ANAHTAR = "AhMuzenKabin";
    let cachedReports = {};

    function sifreCoz(enc) {
        try { return CryptoJS.AES.decrypt(enc, GIZLI_ANAHTAR).toString(CryptoJS.enc.Utf8); } catch (e) { return null; }
    }

    async function checkAdmin() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('admin') === 'true') {
            const pass = prompt("Y√∂netici ≈ûifresi:");
            if (pass === "1234") fetchReports();
            else { alert("Yetkisiz!"); location.href="index.html"; }
        } else {
            document.getElementById('status').innerHTML = "Bu sayfaya doƒürudan eri≈üim yetkiniz yok.";
        }
    }

    async function fetchReports() {
        document.getElementById('status').innerText = "Veriler y√ºkleniyor...";
        try {
            const res = await fetch(DEPO_URL);
            const data = await res.json();
            let html = `<table><tr><th>G√ºven</th><th>ƒ∞hbarcƒ±</th><th>Zaman</th><th>ƒ∞≈ülem</th></tr>`;
            let count = 0;

            data.forEach((row, index) => {
                let fullEnc = "";
                for(let i = 1; i < row.length; i++) if(row[i]) fullEnc += String(row[i]).trim().replace(/^'/, '');
                
                const dec = sifreCoz(fullEnc);
                if(dec) {
                    const item = JSON.parse(dec);
                    cachedReports[index] = item;
                    let color = item.guven > 60 ? "#e63946" : "#2a9d8f";
                    html += `<tr>
                        <td><span class="guven-tag" style="background:${color}">%${item.guven}</span></td>
                        <td>${item.ad}</td><td>${item.olayZamani}</td>
                        <td><button class="btn-view" onclick="openDetail(${index})">G√ñR</button></td>
                    </tr>`;
                    count++;
                }
            });
            document.getElementById('list-container').innerHTML = count > 0 ? html + "</table>" : "ƒ∞hbar yok.";
            document.getElementById('status').innerText = `Toplam ${count} ihbar bulundu.`;
        } catch (e) { document.getElementById('status').innerText = "Veri hatasƒ±!"; }
    }

    function openDetail(index) {
        const item = cachedReports[index];
        document.getElementById('mBody').innerHTML = `
            <b>ƒ∞hbarcƒ±:</b> ${item.ad}<br><b>Zaman:</b> ${item.olayZamani}<br>
            <b>Konum:</b> ${item.koordinat.lat}, ${item.koordinat.lng}<br>
            <b>Detay:</b> <p>${item.detay}</p>`;
        
        document.getElementById('mImages').innerHTML = (item.fotolar || []).map(img => `<img src="${img}" style="width:100%; border-radius:5px;">`).join('');
        document.getElementById('delBtn').onclick = () => deleteReport(index);
        document.getElementById('detailModal').style.display = "block";
    }

    async function deleteReport(index) {
        if(confirm("Silinsin mi?")) {
            await fetch(DEPO_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "delete", rowIndex: index }) });
            location.reload();
        }
    }

    function closeDetail() { document.getElementById('detailModal').style.display = "none"; }
    window.onload = checkAdmin;
</script>
</body>
</html>
